<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The interface which a particular hardware implementation must implement."><title>Hal in virtio_drivers - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-cf3c48c1.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="virtio_drivers" data-themes="" data-resource-suffix="" data-rustdoc-version="1.86.0-nightly (854f22563 2025-01-31)" data-channel="nightly" data-search-js="search-2d513d54.js" data-settings-js="settings-6dad6058.js" ><script src="../static.files/storage-302de22f.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-9b5d7e41.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../virtio_drivers/index.html">virtio_<wbr>drivers</a><span class="version">0.7.1</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Hal</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#safety" title="Safety">Safety</a></li></ul><h3><a href="#required-methods">Required Methods</a></h3><ul class="block"><li><a href="#tymethod.dma_alloc" title="dma_alloc">dma_alloc</a></li><li><a href="#tymethod.dma_dealloc" title="dma_dealloc">dma_dealloc</a></li><li><a href="#tymethod.mmio_phys_to_virt" title="mmio_phys_to_virt">mmio_phys_to_virt</a></li><li><a href="#tymethod.share" title="share">share</a></li><li><a href="#tymethod.unshare" title="unshare">unshare</a></li></ul><h3><a href="#dyn-compatibility">Dyn Compatibility</a></h3><h3><a href="#implementors">Implementors</a></h3></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="index.html">In crate virtio_<wbr>drivers</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="index.html">virtio_drivers</a></div><h1>Trait <span class="trait">Hal</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/virtio_drivers/hal.rs.html#71-134">Source</a> </span></div><pre class="rust item-decl"><code>pub unsafe trait Hal {
    // Required methods
    fn <a href="#tymethod.dma_alloc" class="fn">dma_alloc</a>(
        pages: usize,
        direction: <a class="enum" href="enum.BufferDirection.html" title="enum virtio_drivers::BufferDirection">BufferDirection</a>,
    ) -&gt; (<a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>, NonNull&lt;u8&gt;);
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.dma_dealloc" class="fn">dma_dealloc</a>(
        paddr: <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>,
        vaddr: NonNull&lt;u8&gt;,
        pages: usize,
    ) -&gt; i32;
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.mmio_phys_to_virt" class="fn">mmio_phys_to_virt</a>(paddr: <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>, size: usize) -&gt; NonNull&lt;u8&gt;;
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.share" class="fn">share</a>(
        buffer: NonNull&lt;[u8]&gt;,
        direction: <a class="enum" href="enum.BufferDirection.html" title="enum virtio_drivers::BufferDirection">BufferDirection</a>,
    ) -&gt; <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>;
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.unshare" class="fn">unshare</a>(
        paddr: <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>,
        buffer: NonNull&lt;[u8]&gt;,
        direction: <a class="enum" href="enum.BufferDirection.html" title="enum virtio_drivers::BufferDirection">BufferDirection</a>,
    );
}</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>The interface which a particular hardware implementation must implement.</p>
<h2 id="safety"><a class="doc-anchor" href="#safety">§</a>Safety</h2>
<p>Implementations of this trait must follow the “implementation safety” requirements documented
for each method. Callers must follow the safety requirements documented for the unsafe methods.</p>
</div></details><h2 id="required-methods" class="section-header">Required Methods<a href="#required-methods" class="anchor">§</a></h2><div class="methods"><details class="toggle method-toggle" open><summary><section id="tymethod.dma_alloc" class="method"><a class="src rightside" href="../src/virtio_drivers/hal.rs.html#84">Source</a><h4 class="code-header">fn <a href="#tymethod.dma_alloc" class="fn">dma_alloc</a>(
    pages: usize,
    direction: <a class="enum" href="enum.BufferDirection.html" title="enum virtio_drivers::BufferDirection">BufferDirection</a>,
) -&gt; (<a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>, NonNull&lt;u8&gt;)</h4></section></summary><div class="docblock"><p>Allocates and zeroes the given number of contiguous physical pages of DMA memory for VirtIO
use.</p>
<p>Returns both the physical address which the device can use to access the memory, and a
pointer to the start of it which the driver can use to access it.</p>
<h5 id="implementation-safety"><a class="doc-anchor" href="#implementation-safety">§</a>Implementation safety</h5>
<p>Implementations of this method must ensure that the <code>NonNull&lt;u8&gt;</code> returned is a
<a href="https://doc.rust-lang.org/std/ptr/index.html#safety"><em>valid</em></a> pointer, aligned to
<a href="constant.PAGE_SIZE.html" title="constant virtio_drivers::PAGE_SIZE"><code>PAGE_SIZE</code></a>, and won’t alias any other allocations or references in the program until it
is deallocated by <code>dma_dealloc</code>. The pages must be zeroed.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.dma_dealloc" class="method"><a class="src rightside" href="../src/virtio_drivers/hal.rs.html#93">Source</a><h4 class="code-header">unsafe fn <a href="#tymethod.dma_dealloc" class="fn">dma_dealloc</a>(paddr: <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>, vaddr: NonNull&lt;u8&gt;, pages: usize) -&gt; i32</h4></section></summary><div class="docblock"><p>Deallocates the given contiguous physical DMA memory pages.</p>
<h5 id="safety-1"><a class="doc-anchor" href="#safety-1">§</a>Safety</h5>
<p>The memory must have been allocated by <code>dma_alloc</code> on the same <code>Hal</code> implementation, and not
yet deallocated. <code>pages</code> must be the same number passed to <code>dma_alloc</code> originally, and both
<code>paddr</code> and <code>vaddr</code> must be the values returned by <code>dma_alloc</code>.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.mmio_phys_to_virt" class="method"><a class="src rightside" href="../src/virtio_drivers/hal.rs.html#111">Source</a><h4 class="code-header">unsafe fn <a href="#tymethod.mmio_phys_to_virt" class="fn">mmio_phys_to_virt</a>(paddr: <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>, size: usize) -&gt; NonNull&lt;u8&gt;</h4></section></summary><div class="docblock"><p>Converts a physical address used for MMIO to a virtual address which the driver can access.</p>
<p>This is only used for MMIO addresses within BARs read from the device, for the PCI
transport. It may check that the address range up to the given size is within the region
expected for MMIO.</p>
<h5 id="implementation-safety-1"><a class="doc-anchor" href="#implementation-safety-1">§</a>Implementation safety</h5>
<p>Implementations of this method must ensure that the <code>NonNull&lt;u8&gt;</code> returned is a
<a href="https://doc.rust-lang.org/std/ptr/index.html#safety"><em>valid</em></a> pointer, and won’t alias any
other allocations or references in the program.</p>
<h5 id="safety-2"><a class="doc-anchor" href="#safety-2">§</a>Safety</h5>
<p>The <code>paddr</code> and <code>size</code> must describe a valid MMIO region. The implementation may validate it
in some way (and panic if it is invalid) but is not guaranteed to.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.share" class="method"><a class="src rightside" href="../src/virtio_drivers/hal.rs.html#123">Source</a><h4 class="code-header">unsafe fn <a href="#tymethod.share" class="fn">share</a>(buffer: NonNull&lt;[u8]&gt;, direction: <a class="enum" href="enum.BufferDirection.html" title="enum virtio_drivers::BufferDirection">BufferDirection</a>) -&gt; <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a></h4></section></summary><div class="docblock"><p>Shares the given memory range with the device, and returns the physical address that the
device can use to access it.</p>
<p>This may involve mapping the buffer into an IOMMU, giving the host permission to access the
memory, or copying it to a special region where it can be accessed.</p>
<h5 id="safety-3"><a class="doc-anchor" href="#safety-3">§</a>Safety</h5>
<p>The buffer must be a valid pointer to a non-empty memory range which will not be accessed by
any other thread for the duration of this method call.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.unshare" class="method"><a class="src rightside" href="../src/virtio_drivers/hal.rs.html#133">Source</a><h4 class="code-header">unsafe fn <a href="#tymethod.unshare" class="fn">unshare</a>(
    paddr: <a class="type" href="type.PhysAddr.html" title="type virtio_drivers::PhysAddr">PhysAddr</a>,
    buffer: NonNull&lt;[u8]&gt;,
    direction: <a class="enum" href="enum.BufferDirection.html" title="enum virtio_drivers::BufferDirection">BufferDirection</a>,
)</h4></section></summary><div class="docblock"><p>Unshares the given memory range from the device and (if necessary) copies it back to the
original buffer.</p>
<h5 id="safety-4"><a class="doc-anchor" href="#safety-4">§</a>Safety</h5>
<p>The buffer must be a valid pointer to a non-empty memory range which will not be accessed by
any other thread for the duration of this method call. The <code>paddr</code> must be the value
previously returned by the corresponding <code>share</code> call.</p>
</div></details></div><h2 id="dyn-compatibility" class="section-header">Dyn Compatibility<a href="#dyn-compatibility" class="anchor">§</a></h2><div class="dyn-compatibility-info"><p>This trait is <b>not</b> <a href="https://doc.rust-lang.org/nightly/reference/items/traits.html#dyn-compatibility">dyn compatible</a>.</p><p><i>In older versions of Rust, dyn compatibility was called "object safety", so this trait is not object safe.</i></p></div><h2 id="implementors" class="section-header">Implementors<a href="#implementors" class="anchor">§</a></h2><div id="implementors-list"></div><script src="../trait.impl/virtio_drivers/hal/trait.Hal.js" async></script></section></div></main></body></html>